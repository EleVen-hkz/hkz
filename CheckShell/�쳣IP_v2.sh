#!/bin/bash
AIPFile=/tmp/Allow_IP.tmp
OutFile=/tmp/HW.outfile
Successlogfile=/tmp/success.tmp
Failedlogfile=/tmp/failed.tmp
Mon=`date|awk '{print $2}'`
error=0
echo -n '' > ${AIPFile}
echo -n '' > ${OutFile}
Allow_IP(){
    echo -n '10.212.210.196  10.212.210.197  10.212.210.198  10.212.210.199  10.212.210.200  10.212.210.201  10.212.210.202  10.212.210.203  10.212.210.204  10.212.210.208  10.212.210.212  10.212.210.216  10.212.210.220  10.212.210.224  10.212.210.226  10.212.210.227  10.212.210.230  10.212.210.231  10.212.210.232  10.212.210.233  10.212.210.234  10.212.210.235  10.212.210.236  10.212.210.237  10.212.210.238  10.212.210.239  10.212.210.243  10.212.210.245  10.212.210.246  10.212.210.249  10.212.210.254  10.212.211.6  10.212.211.7  10.212.220.100  10.212.220.101  10.212.220.102  10.212.220.103  10.212.220.104  10.212.220.105  10.212.220.106  10.212.220.107  10.212.220.108  10.212.220.109  10.212.220.110  10.212.220.111  10.212.220.112  10.212.220.113  10.212.220.114  10.212.220.115  10.212.220.116  10.212.220.117  10.212.220.118  10.212.220.119  10.212.220.120  10.212.220.121  10.212.220.122  10.212.220.123  10.212.220.124  10.212.220.125  10.212.220.126  10.212.220.66  10.212.220.67  10.212.220.68  10.212.220.69  10.212.220.70  10.212.220.71  10.212.220.72  10.212.220.74  10.212.220.75  10.212.220.76  10.212.220.77  10.212.220.78  10.212.220.79  10.212.220.80  10.212.220.81  10.212.220.82  10.212.220.83  10.212.220.84  10.212.220.85  10.212.220.86  10.212.220.87  10.212.220.88  10.212.220.89  10.212.220.90  10.212.220.91  10.212.220.92  10.212.220.93  10.212.220.94  10.212.220.95  10.212.220.96  10.212.220.97  10.212.220.98  10.212.220.99  10.212.234.10  10.212.234.11  10.212.234.12  10.212.234.13  10.212.234.14  10.212.234.15  10.212.234.16  10.212.234.17  10.212.234.2  10.212.234.22  10.212.234.23  10.212.234.24  10.212.234.25  10.212.234.3  10.212.234.30  10.212.234.4  10.212.234.5  10.212.234.6  10.212.234.7  10.212.234.8  10.212.234.9  10.212.241.7  10.212.41.108  10.212.41.116  10.212.41.120  10.212.41.125  10.212.41.87  10.212.41.88  10.212.51.128  10.212.51.129  10.212.51.130  10.212.51.132  10.212.51.133  10.212.51.134  10.212.51.136  10.212.51.137  10.212.51.138  10.212.51.139  10.212.51.140  10.212.51.142  10.212.51.143  10.212.51.145  10.212.51.146  10.212.51.151  10.212.51.152  10.212.51.153  10.212.51.154  10.212.51.155  10.212.51.156  10.212.51.157  10.212.51.158  10.212.51.159  10.212.51.160  10.212.51.161  10.212.51.162  10.212.51.163  10.212.51.166  10.212.51.168  10.212.51.169  10.212.51.170  10.212.51.171  10.212.51.172  10.212.51.173  10.212.51.176  10.212.51.177  10.212.51.178  10.212.51.179  10.212.51.180  10.212.51.181  10.212.51.211  10.212.51.212  10.212.51.213  10.212.51.214  10.212.64.179  10.212.64.180  10.212.67.104  10.212.67.71  10.76.131.130  10.76.131.131  10.76.131.132  10.76.131.133  10.76.131.134  10.76.131.135  10.76.131.136  10.76.131.137  10.76.131.138  10.76.131.139  10.76.139.130  10.76.139.131  10.76.139.132  10.76.139.133  10.76.149.191  10.76.149.192  10.76.149.193  10.76.149.194  10.76.149.195  10.76.149.196  10.76.149.197  10.76.149.198  10.76.149.199  10.76.149.200  10.76.149.201  10.76.149.202  10.76.149.203  10.76.149.204  10.76.149.205  10.76.149.206  188.102.16.154  188.102.16.155  188.102.18.100  188.102.18.101  188.102.18.102  188.102.18.103  188.102.18.104  188.102.18.105  188.102.18.106  188.102.18.107  188.102.18.98  188.102.18.99 ' > ${AIPFile}

 }

SuccessLogin(){
   #SIP=`last -i|grep -v begins|grep -v 0.0.0.0|grep ${Mon}|awk -v day=$[$(date +%d)-1] '{if($(NF-4)>=day){print $(NF-7)}}'|sort |uniq`
   last -i|grep -v begins|grep -v 0.0.0.0|grep ${Mon}|awk -v day=$[$(date +%d)-1] '{if($(NF-4)>=day){print $1,$(NF-7)}}'|sort |uniq > ${Successlogfile} 
    for IP in `cat ${Successlogfile} |awk '{print $2}'|sort|uniq`; do
        Isok=`grep -w ${IP} ${AIPFile}`
        if [[ ! ${Isok} ]]; then
            #非法IP已经成功登录
            User=`grep -w ${IP} ${Successlogfile} |awk '{print $1}'|sort |uniq`
            echo "非法IP[${IP}]成功登录$(echo ${User})用户" >> ${OutFile}
            error=11
        fi
    done 
}

FaildLogin(){
    #lastb -i |grep -E "([0-9]{1,3}[\.]){3}[0-9]{1,3}"|awk '{print $3}'|sort |uniq
    lastb -i |grep -v begins|grep ${Mon}|awk -v day=$[$(date +%d)-1] '{if($6>=day)print$1,$3}'|sort|uniq > ${Failedlogfile}
    for FIP in `cat ${Failedlogfile} |awk '{print $2}'|sort|uniq`; do
        IsokF=`grep -wo ${FIP} ${AIPFile}`
        if [[ ! ${IsokF} ]]; then
            #非法IP尝试登录
            FUser=`grep -w ${FIP} ${Failedlogfile}|awk '{print $1}'|sort |uniq`
            echo "非法IP[${FIP}]尝试登录$(echo ${FUser})用户" >> ${OutFile} 
            error=1
        fi
    done

}

Allow_IP
FaildLogin
echo '-----------------------------------------------------------------------'>>${OutFile} 
SuccessLogin
echo ${error}
